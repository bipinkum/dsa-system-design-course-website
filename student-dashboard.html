<!DOCTYPE html>
<html>
<head>
  <title>Student Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { padding: 8px; margin-right: 10px; width: 250px; }
    button { padding: 8px 12px; }
    #status { margin-top: 10px; color: green; }
    #courses div { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Welcome to Your Dashboard</h1>

  <!-- Step 1: Email input for magic link -->
  <form id="magicLinkForm">
    <input type="email" id="email" placeholder="Enter your email" required />
    <button type="submit">Get Magic Link</button>
    <div id="status"></div>
  </form>

  <!-- Step 2: Courses will appear here -->
  <div id="courses"></div>

  <script>
    const form = document.getElementById("magicLinkForm");
    const statusDiv = document.getElementById("status");
    const coursesContainer = document.getElementById("courses");

    // ✅ Send magic link without leaving page
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value;
      statusDiv.style.color = "black";
      statusDiv.innerText = "Sending magic link...";

      try {
        const res = await fetch("https://dsa-system-design-course-website.onrender.com/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        if (res.ok) {
          statusDiv.style.color = "green";
          statusDiv.innerText = "✅ Magic link sent! Check your email.";
        } else {
          statusDiv.style.color = "red";
          statusDiv.innerText = `❌ ${data.error}`;
        }
      } catch (err) {
        console.error(err);
        statusDiv.style.color = "red";
        statusDiv.innerText = "❌ Failed to send magic link.";
      }
    });

    // ✅ Fetch courses using cookie (after backend sets HTTP-only cookie)
    async function loadCourses() {
      try {
        const res = await fetch("https://dsa-system-design-course-website.onrender.com/api/student-courses", {
          credentials: "include" // sends HTTP-only cookie
        });

        if (!res.ok) {
          // User not logged in or session expired
          return;
        }

        const data = await res.json();

        if (data.courses && data.courses.length > 0) {
          // Hide email form
          form.style.display = "none";

          // Render courses
          data.courses.forEach(course => {
            const div = document.createElement("div");
            div.innerHTML = `
              <h2>${course.name}</h2>
              <video src="${course.videoUrl}" controls width="600"></video>
            `;
            coursesContainer.appendChild(div);
          });
        }
      } catch (err) {
        console.error("Error fetching courses:", err);
      }
    }

    // Call on page load
    loadCourses();
  </script>
</body>
</html>
